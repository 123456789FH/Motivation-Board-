<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙÙŠØ² Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --text:#e8eefc;
      --muted:#aab6d6;
      --line:rgba(255,255,255,.10);
      --accent:#5eead4;
      --accent2:#60a5fa;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Arial;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.25), transparent 60%),
        radial-gradient(1000px 700px at 100% 10%, rgba(94,234,212,.18), transparent 55%),
        linear-gradient(180deg, #070b14, #0b1220 45%, #070b14);
      color:var(--text);
      min-height:100vh;
    }

    /* âœ… ØªÙˆØ³Ø¹Ø© Ø§Ù„Ù„ÙˆØ­Ø© */
    .wrap{
      max-width:1500px;
      margin:0 auto;
      padding:18px;
      display:grid;
      grid-template-columns: 340px minmax(0, 1fr);
      gap:16px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:linear-gradient(90deg, rgba(96,165,250,.10), rgba(94,234,212,.06));
    }
    .title{
      font-weight:900;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      font-size:12px;
      color:#0b1220;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      padding:4px 10px;
      border-radius:999px;
      font-weight:900;
    }
    .bd{padding:14px}

    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin:0 0 6px;
    }
    input, textarea{
      width:100%;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
      font-family:inherit;
    }
    textarea{min-height:130px; resize:vertical}
    input:focus, textarea:focus{border-color:rgba(94,234,212,.55)}
    .row{display:grid; grid-template-columns:1fr; gap:10px}
    .btns{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}

    button{
      border:0;
      cursor:pointer;
      font-family:inherit;
      font-weight:900;
      padding:10px 12px;
      border-radius:14px;
      color:#08101f;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      transition: transform .08s ease, filter .15s ease;
    }
    button:hover{filter:saturate(1.08)}
    button:active{transform:translateY(1px)}
    button.secondary{
      background:rgba(255,255,255,.08);
      color:var(--text);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
    }
    button.danger{
      background:rgba(251,113,133,.18);
      color:#ffd7df;
      border:1px solid rgba(251,113,133,.35);
      box-shadow:none;
    }

    /* Palette */
    .palette{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      padding:12px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:16px;
      background:rgba(255,255,255,.03);
    }
    .token{
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
    }
    .token[draggable="true"]{cursor:grab}
    .token:active{cursor:grabbing}
    .small{font-size:12px;color:var(--muted); line-height:1.6}

    /* Board */
    .boardWrap{padding:14px}
    .board{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12);
      border-radius:22px;
      overflow:hidden;
    }
    .boardHeader{
      padding:18px 18px 12px;
      border-bottom:1px solid var(--line);
      background:
        radial-gradient(900px 320px at 0% 0%, rgba(96,165,250,.18), transparent 55%),
        radial-gradient(900px 320px at 100% 0%, rgba(94,234,212,.16), transparent 55%),
        rgba(255,255,255,.02);
    }
    .boardTitle{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .boardTitle h1{
      margin:0;
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
    }
    .infoGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){ .infoGrid{grid-template-columns: 1fr} }
    .infoItem{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      min-height:56px;
    }
    .infoItem .k{color:var(--muted); font-size:12px}
    .infoItem .v{font-weight:900; margin-top:4px; font-size:14px; white-space:pre-wrap}

    .table{
      width:100%;
      border-collapse:collapse;
    }
    .table th, .table td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:14px 12px;
      vertical-align:middle;
    }
    .table th{
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      background:rgba(255,255,255,.02);
      white-space:nowrap;
    }
    .idx{width:56px; color:var(--muted); font-weight:900; text-align:center}
    .groupCell{
      font-weight:900;
      font-size:16px;
      width:280px;
      line-height:1.35;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .groupName{flex:1; min-width:120px}
    .miniBtn{
      padding:7px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
    }

    .critZone{
      border:1px dashed rgba(255,255,255,.20);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      min-height:62px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .critZone.dragover{
      border-color: rgba(94,234,212,.65);
      box-shadow: 0 0 0 3px rgba(94,234,212,.10) inset;
    }
    .critLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:120px;
    }
    .critIcon{
      font-size:18px;
      width:30px;
      height:30px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
    }
    .critCount{
      font-weight:900;
      font-size:18px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      min-width:54px;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    .critBtns{display:flex; gap:8px; align-items:center}
    .critBtn{
      width:36px;
      height:36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .totalBadge{
      font-weight:900;
      font-size:16px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      text-align:center;
      min-width:64px;
      display:inline-block;
    }
    tfoot td{
      background:rgba(255,255,255,.02);
      font-weight:900;
      color:rgba(232,238,252,.95);
    }

    .footer{
      padding:12px 18px 14px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      border-top:1px solid var(--line);
      background:rgba(255,255,255,.02);
    }
    .footer .sig{font-weight:900; color:rgba(232,238,252,.95)}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      font-weight:900;
    }

    .toast{
      position:fixed;
      bottom:16px;
      left:16px;
      right:16px;
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index:50;
    }
    .toast .box{
      pointer-events:none;
      background:rgba(17, 28, 53, .92);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      max-width:860px;
      width:100%;
      box-shadow:var(--shadow);
      opacity:0;
      transform:translateY(10px);
      transition: opacity .18s ease, transform .18s ease;
      text-align:center;
      font-weight:900;
    }
    .toast .box.show{opacity:1; transform:translateY(0)}

    /* âœ… ØªØ°ÙŠÙŠÙ„ Ø·Ø¨Ø§Ø¹Ø© Ø«Ø§Ø¨Øª Ø£Ø³ÙÙ„ Ø§Ù„ÙˆØ±Ù‚Ø© */
    #printFooter{display:none; font-family:"Tajawal", Arial;}

    /* ===== Export / Print (High Contrast) ===== */
    body.exporting{
      background:#fff !important;
      color:#0f172a !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;

      --text:#0f172a;
      --muted:#475569;
      --line:rgba(15,23,42,.18);
      --shadow:none;
    }
    body.exporting .controls{display:none !important;}
    body.exporting .wrap{grid-template-columns:1fr !important;}
    body.exporting .card,
    body.exporting .board,
    body.exporting .boardHeader{
      background:#fff !important;
      box-shadow:none !important;
    }
    body.exporting .table th{
      color:#334155 !important;
      background:#f1f5f9 !important;
    }
    body.exporting .table td{ color:#0f172a !important; }
    body.exporting .critZone{
      background:#fff !important;
      border-color:rgba(15,23,42,.22) !important;
    }
    body.exporting .critBtn,
    body.exporting .critIcon,
    body.exporting .critCount,
    body.exporting .totalBadge,
    body.exporting .miniBtn{
      color:#0f172a !important;
      border-color:rgba(15,23,42,.22) !important;
      background:#fff !important;
    }
    body.exporting .badge{color:#0f172a !important; border-color:rgba(15,23,42,.22) !important; background:#fff !important;}

    @media print{
      @page{ margin: 12mm 10mm 18mm 10mm; }
      body{
        background:#fff !important;
        color:#0f172a !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .controls{ display:none !important; }
      .wrap{ grid-template-columns:1fr !important; }

      .card, .board, .boardHeader{ background:#fff !important; box-shadow:none !important; }
      .table th{ color:#334155 !important; background:#f1f5f9 !important; }
      .table td{ color:#0f172a !important; }
      .critZone{ background:#fff !important; border-color:rgba(15,23,42,.22) !important; }
      .critBtn,.critIcon,.critCount,.totalBadge,.miniBtn{ color:#0f172a !important; border-color:rgba(15,23,42,.22) !important; background:#fff !important; }

      /* âœ… Ø§Ø¬Ø¹Ù„ Ø§Ù„ØªØ°ÙŠÙŠÙ„ ÙŠØ¸Ù‡Ø± ÙƒØªØ°ÙŠÙŠÙ„ Ø£Ø³ÙÙ„ Ø§Ù„ÙˆØ±Ù‚Ø© */
      .footer{display:none !important;}
      #printFooter{
        display:block !important;
        position: fixed;
        left:0; right:0; bottom:0;
        background:#fff;
        color:#0f172a;
        border-top:1px solid rgba(15,23,42,.18);
        padding:8px 14px;
        text-align:center;
        font-size:12px;
        font-weight:900;
        z-index:9999;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Controls -->
    <div class="card controls">
      <div class="hd">
        <div class="title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª <span class="pill">Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª</span></div>
      </div>
      <div class="bd">
        <div class="row">
          <div>
            <label>Ø§Ù„ØµÙ</label>
            <input id="in_grade" placeholder="Ù…Ø«Ø§Ù„: Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ" />
          </div>
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ù€Ø©</label>
            <input id="in_teacher" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" />
          </div>
        </div>

        <div style="margin-top:12px;">
          <label>ğŸ¯ Ø§Ø³Ø­Ø¨ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ£ÙÙ„ØªÙŠÙ‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
          <div class="palette" id="palette">
            <span class="token" draggable="true" data-points="1" title="Ø§Ø³Ø­Ø¨ÙŠ ÙˆØ£ÙÙ„ØªÙŠ">â­ +1</span>
            <span class="token" draggable="true" data-points="2" title="Ø§Ø³Ø­Ø¨ÙŠ ÙˆØ£ÙÙ„ØªÙŠ">ğŸŒŸ +2</span>
            <span class="token" draggable="true" data-points="3" title="Ø§Ø³Ø­Ø¨ÙŠ ÙˆØ£ÙÙ„ØªÙŠ">ğŸ… +3</span>
            <span class="small">ØªÙ„Ù…ÙŠØ­: Ø§Ø¶ØºØ·ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ù†Ø¯ Ù„Ø¥Ø²Ø§Ù„Ø© (-1). ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ù‹Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… (+/âˆ’).</span>
          </div>
        </div>

        <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">

        <div class="row">
          <div>
            <label>Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (Ø³Ø·Ø± Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©)</label>
            <textarea id="in_groups" placeholder="Ù…Ø«Ø§Ù„:
Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© 1
Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© 2
Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© 3"></textarea>
          </div>
        </div>

        <div class="btns">
          <button id="btn_add">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</button>
          <button class="secondary" id="btn_sort">â†•ï¸ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</button>
          <button class="secondary" id="btn_reset_all">ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
          <button class="danger" id="btn_clear">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        </div>

        <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">

        <div class="btns">
          <button id="btn_pdf">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
          <button class="secondary" id="btn_json">ğŸ’¾ ØªØµØ¯ÙŠØ± JSON</button>

          <label class="miniBtn" style="display:inline-flex;align-items:center;gap:8px;">
            â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
            <input id="file_json" type="file" accept="application/json" style="display:none">
          </label>

          <button class="secondary" id="btn_save">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¢Ù†</button>
        </div>

        <div class="small" style="margin-top:10px;">
          âœ… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø· (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­).<br>
          ğŸ§© Ù…Ù† Ø²Ø± (â€¦ ) Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©/Ø­Ø°Ù/ØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.
        </div>
      </div>
    </div>

    <!-- Board -->
    <div class="card">
      <div class="hd">
        <div class="title">â­ Ù„ÙˆØ­Ø© ØªØ­ÙÙŠØ² Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª <span class="pill" id="groupsCount">0 Ù…Ø¬Ù…ÙˆØ¹Ø©</span></div>
        <div class="badge">ğŸŸ¢ <span id="saveState">Ù…Ø­ÙÙˆØ¸</span></div>
      </div>

      <div class="boardWrap">
        <div class="board" id="board">
          <div class="boardHeader">
            <div class="boardTitle">
              <div>
                <h1>Ù„ÙˆØ­Ø© ØªØ­ÙÙŠØ² Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h1>
                <div class="sub">Ø§Ø±ØµØ¯ÙŠ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆÙÙ‚ Ø§Ù„Ø¨Ù†ÙˆØ¯: Ø§Ù„Ù‡Ø¯ÙˆØ¡ â€“ Ø§Ù„ØªØ¹Ø§ÙˆÙ† â€“ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² â€“ ØµØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø©</div>
              </div>
              <div class="badge" id="exportStamp">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: â€”</div>
            </div>

            <div class="infoGrid">
              <div class="infoItem"><div class="k">Ø§Ù„ØµÙ</div><div class="v" id="v_grade">â€”</div></div>
              <div class="infoItem"><div class="k">Ø§Ù„Ù…Ø¹Ù„Ù…/Ù€Ø©</div><div class="v" id="v_teacher">â€”</div></div>
              <div class="infoItem"><div class="k">Ø§Ù„ØªØ§Ø±ÙŠØ®</div><div class="v" id="v_date">â€”</div></div>
            </div>
          </div>

          <div style="padding:8px 0; overflow:auto;">
            <table class="table" id="groupsTable">
              <thead>
                <tr>
                  <th class="idx">#</th>
                  <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
                  <th>ğŸ”‡ Ø§Ù„Ù‡Ø¯ÙˆØ¡</th>
                  <th>ğŸ¤ Ø§Ù„ØªØ¹Ø§ÙˆÙ†</th>
                  <th>âš¡ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</th>
                  <th>âœ… ØµØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø©</th>
                  <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
              <tfoot>
                <tr>
                  <td colspan="2" style="text-align:right;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙ</td>
                  <td id="t_calm">0</td>
                  <td id="t_coop">0</td>
                  <td id="t_speed">0</td>
                  <td id="t_acc">0</td>
                  <td id="t_total">0</td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- âœ… ØªØ°ÙŠÙŠÙ„ Ø¯Ø§Ø®Ù„ÙŠ ÙŠØ¸Ù‡Ø± ÙÙŠ PDF -->
          <div class="footer">
            <div class="sig" id="v_footer">â€”</div>
            <div>Â© Ù„ÙˆØ­Ø© ØªØ­ÙÙŠØ² Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª â€” ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø«Ø§Ø¨Øª -->
  <div id="printFooter"></div>

  <!-- Toast -->
  <div class="toast"><div class="box" id="toastBox">ØªÙ…</div></div>

  <!-- Libraries for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // ========= Ø«Ø§Ø¨Øª: Ø§Ù„ØªØ°ÙŠÙŠÙ„ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ =========
    const FOOTER_TEXT = "Ø£/ ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ | Ù…Ù„ØªÙ‚Ù‰ Ù…Ø¹Ù„Ù…ÙŠ ÙˆÙ…Ø¹Ù„Ù…Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª | Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ";
    const STORAGE_KEY = "group_motivation_board_v1";

    const CRIT = {
      calm:     {label:"Ø§Ù„Ù‡Ø¯ÙˆØ¡", icon:"ğŸ”‡"},
      coop:     {label:"Ø§Ù„ØªØ¹Ø§ÙˆÙ†", icon:"ğŸ¤"},
      speed:    {label:"Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²", icon:"âš¡"},
      accuracy: {label:"ØµØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø©", icon:"âœ…"},
    };

    // ========= Helpers =========
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
    const deepClone = (obj) => (window.structuredClone ? structuredClone(obj) : JSON.parse(JSON.stringify(obj)));

    function nowStamp(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function dateOnly(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
    }
    function toast(msg){
      const box = $("#toastBox");
      box.textContent = msg;
      box.classList.add("show");
      setTimeout(()=> box.classList.remove("show"), 1600);
    }
    function downloadFile(filename, content, mime){
      const blob = new Blob([content], {type: mime});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 0);
    }

    // ========= State =========
    const defaultState = {
      meta: { app: "Ù„ÙˆØ­Ø© ØªØ­ÙÙŠØ² Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª", version: "1.0.0" },
      header: {
        grade: "",
        teacher: "",
        date: "",
        footer: FOOTER_TEXT
      },
      groups: [] // {id, name, scores:{calm, coop, speed, accuracy}}
    };

    let state = loadState();
    let saveTimer = null;

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return deepClone(defaultState);
        const parsed = JSON.parse(raw);
        const fixed = {
          ...deepClone(defaultState),
          ...parsed,
          header: { ...deepClone(defaultState.header), ...(parsed.header||{}) },
          groups: Array.isArray(parsed.groups) ? parsed.groups : []
        };
        fixed.header.footer = FOOTER_TEXT;
        return fixed;
      }catch(e){
        return deepClone(defaultState);
      }
    }

    function markSaving(isSaving){
      $("#saveState").textContent = isSaving ? "Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸..." : "Ù…Ø­ÙÙˆØ¸";
    }
    function saveState(immediate=false){
      markSaving(true);
      if(saveTimer) clearTimeout(saveTimer);
      const doSave = () => {
        state.header.footer = FOOTER_TEXT;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        markSaving(false);
        $("#exportStamp").textContent = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + nowStamp();
      };
      if(immediate) doSave();
      else saveTimer = setTimeout(doSave, 250);
    }

    // ========= Render =========
    function setText(sel, val){
      const el = $(sel);
      el.textContent = (val && String(val).trim()) ? val : "â€”";
    }
    function syncInputsFromState(){
      $("#in_grade").value = state.header.grade || "";
      $("#in_teacher").value = state.header.teacher || "";
    }
    function renderHeader(){
      setText("#v_grade", state.header.grade);
      setText("#v_teacher", state.header.teacher);
      setText("#v_date", state.header.date || dateOnly());

      // footer fixed
      setText("#v_footer", FOOTER_TEXT);
      $("#printFooter").textContent = FOOTER_TEXT;
    }

    function groupTotal(g){
      const s = g.scores || {};
      return (s.calm||0) + (s.coop||0) + (s.speed||0) + (s.accuracy||0);
    }
    function totalsAll(){
      const t = {calm:0, coop:0, speed:0, accuracy:0, total:0};
      state.groups.forEach(g=>{
        t.calm += g.scores?.calm||0;
        t.coop += g.scores?.coop||0;
        t.speed += g.scores?.speed||0;
        t.accuracy += g.scores?.accuracy||0;
      });
      t.total = t.calm + t.coop + t.speed + t.accuracy;
      return t;
    }

    function renderTotals(){
      const t = totalsAll();
      $("#t_calm").textContent = t.calm;
      $("#t_coop").textContent = t.coop;
      $("#t_speed").textContent = t.speed;
      $("#t_acc").textContent = t.accuracy;
      $("#t_total").textContent = t.total;
      $("#groupsCount").textContent = `${state.groups.length} Ù…Ø¬Ù…ÙˆØ¹Ø©`;
    }

    function makeCritCell(g, key){
      const td = document.createElement("td");

      const zone = document.createElement("div");
      zone.className = "critZone";
      zone.dataset.groupId = g.id;
      zone.dataset.crit = key;
      zone.title = "Ø§Ø³Ø­Ø¨ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ£ÙÙ„ØªÙŠÙ‡Ø§ Ù‡Ù†Ø§";

      zone.addEventListener("dragover", (ev)=>{ ev.preventDefault(); zone.classList.add("dragover"); });
      zone.addEventListener("dragleave", ()=> zone.classList.remove("dragover"));
      zone.addEventListener("drop", (ev)=>{
        ev.preventDefault();
        zone.classList.remove("dragover");
        const p = parseInt(ev.dataTransfer.getData("text/points") || "1", 10);
        adjustScore(g.id, key, Number.isFinite(p)? p : 1);
      });

      // double click add +1
      zone.addEventListener("dblclick", ()=> adjustScore(g.id, key, 1));

      const left = document.createElement("div");
      left.className = "critLeft";

      const icon = document.createElement("span");
      icon.className = "critIcon";
      icon.textContent = CRIT[key].icon;

      const count = document.createElement("span");
      count.className = "critCount";
      count.textContent = (g.scores?.[key] ?? 0);
      count.title = "Ø§Ø¶ØºØ·ÙŠ Ù„Ø¥Ø²Ø§Ù„Ø© (-1)";
      count.addEventListener("click", ()=> adjustScore(g.id, key, -1));

      left.appendChild(icon);
      left.appendChild(count);

      const btns = document.createElement("div");
      btns.className = "critBtns";

      const plus = document.createElement("button");
      plus.className = "critBtn";
      plus.type = "button";
      plus.textContent = "+";
      plus.addEventListener("click", ()=> adjustScore(g.id, key, 1));

      const minus = document.createElement("button");
      minus.className = "critBtn";
      minus.type = "button";
      minus.textContent = "âˆ’";
      minus.addEventListener("click", ()=> adjustScore(g.id, key, -1));

      btns.appendChild(plus);
      btns.appendChild(minus);

      zone.appendChild(left);
      zone.appendChild(btns);

      td.appendChild(zone);
      return td;
    }

    function renderGroups(){
      const tbody = $("#tbody");
      tbody.innerHTML = "";

      state.groups.forEach((g, idx)=>{
        const tr = document.createElement("tr");

        const tdIdx = document.createElement("td");
        tdIdx.className = "idx";
        tdIdx.textContent = (idx+1);

        const tdGroup = document.createElement("td");
        tdGroup.className = "groupCell";

        const name = document.createElement("div");
        name.className = "groupName";
        name.textContent = g.name;

        const menu = document.createElement("button");
        menu.className = "miniBtn";
        menu.type = "button";
        menu.textContent = "â€¦";
        menu.title = "Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©";
        menu.addEventListener("click", ()=> openGroupMenu(g.id));

        tdGroup.appendChild(name);
        tdGroup.appendChild(menu);

        tr.appendChild(tdIdx);
        tr.appendChild(tdGroup);

        tr.appendChild(makeCritCell(g, "calm"));
        tr.appendChild(makeCritCell(g, "coop"));
        tr.appendChild(makeCritCell(g, "speed"));
        tr.appendChild(makeCritCell(g, "accuracy"));

        const tdTotal = document.createElement("td");
        const badge = document.createElement("span");
        badge.className = "totalBadge";
        badge.textContent = groupTotal(g);
        tdTotal.appendChild(badge);
        tr.appendChild(tdTotal);

        tbody.appendChild(tr);
      });

      renderTotals();
    }

    function renderAll(){
      renderHeader();
      renderGroups();
      $("#exportStamp").textContent = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + nowStamp();
    }

    // ========= Mutations =========
    function updateHeaderFromInputs(){
      state.header.grade = $("#in_grade").value.trim();
      state.header.teacher = $("#in_teacher").value.trim();
      if(!state.header.date) state.header.date = dateOnly();
      state.header.footer = FOOTER_TEXT;
      renderHeader();
      saveState();
    }

    function addGroupsFromTextarea(){
      const raw = $("#in_groups").value;
      const names = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(!names.length){ toast("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return; }

      const newOnes = names.map(n=>({
        id: uid(),
        name: n,
        scores: { calm:0, coop:0, speed:0, accuracy:0 }
      }));

      state.groups.push(...newOnes);
      $("#in_groups").value = "";
      renderGroups();
      saveState();
      toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª âœ…");
    }

    function adjustScore(groupId, critKey, delta){
      const g = state.groups.find(x=>x.id===groupId);
      if(!g) return;
      if(!g.scores) g.scores = { calm:0, coop:0, speed:0, accuracy:0 };
      const curr = g.scores[critKey] || 0;
      const next = Math.max(0, curr + delta);
      g.scores[critKey] = next;
      renderGroups();
      saveState();
    }

    function clearList(){
      state.groups = [];
      renderGroups();
      saveState();
      toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©");
    }

    function resetAllScores(){
      state.groups.forEach(g=>{
        g.scores = { calm:0, coop:0, speed:0, accuracy:0 };
      });
      renderGroups();
      saveState();
      toast("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø¬Ù…ÙŠØ¹");
    }

    function sortByTotal(){
      state.groups.sort((a,b)=> groupTotal(b)-groupTotal(a));
      renderGroups();
      saveState();
      toast("ØªÙ… Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹");
    }

    function openGroupMenu(groupId){
      const g = state.groups.find(x=>x.id===groupId);
      if(!g) return;

      const choice = prompt(
`Ø§Ø®ØªØ§Ø±ÙŠ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:
1) Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
2) ØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
3) Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©`,
"1"
      );
      if(!choice) return;

      if(choice.trim()==="1"){
        const newName = prompt("Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", g.name);
        if(newName && newName.trim()){
          g.name = newName.trim();
          renderGroups();
          saveState();
          toast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…");
        }
      }else if(choice.trim()==="2"){
        g.scores = { calm:0, coop:0, speed:0, accuracy:0 };
        renderGroups();
        saveState();
        toast("ØªÙ… ØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
      }else if(choice.trim()==="3"){
        state.groups = state.groups.filter(x=>x.id!==groupId);
        renderGroups();
        saveState();
        toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
      }
    }

    // ========= Drag Palette =========
    function setupPalette(){
      $$("#palette .token").forEach(el=>{
        el.addEventListener("dragstart",(ev)=>{
          ev.dataTransfer.setData("text/points", el.dataset.points || "1");
          ev.dataTransfer.effectAllowed = "copy";
        });
      });
    }

    // ========= Export JSON =========
    function exportJSON(){
      state.header.footer = FOOTER_TEXT;
      if(!state.header.date) state.header.date = dateOnly();

      const payload = {
        ...state,
        meta: {
          ...state.meta,
          exportedAt: new Date().toISOString(),
          exportedAtDisplay: nowStamp()
        }
      };
      const fileName = `Ù„ÙˆØ­Ø©-ØªØ­ÙÙŠØ²-Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª_${new Date().toISOString().slice(0,10)}.json`;
      downloadFile(fileName, JSON.stringify(payload, null, 2), "application/json;charset=utf-8");
      toast("ØªÙ… ØªØµØ¯ÙŠØ± JSON");
    }

    async function importJSON(file){
      try{
        const txt = await file.text();
        const data = JSON.parse(txt);
        if(!data || !data.header || !Array.isArray(data.groups)){
          toast("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
          return;
        }

        state = {
          meta: data.meta?.app ? data.meta : deepClone(defaultState.meta),
          header: {
            grade: (data.header.grade||"").trim(),
            teacher: (data.header.teacher||"").trim(),
            date: (data.header.date||"").trim() || dateOnly(),
            footer: FOOTER_TEXT
          },
          groups: (data.groups||[]).map(g=>({
            id: g.id || uid(),
            name: (g.name||"").trim() || "Ù…Ø¬Ù…ÙˆØ¹Ø©",
            scores: {
              calm: Math.max(0, Number(g.scores?.calm||0)),
              coop: Math.max(0, Number(g.scores?.coop||0)),
              speed: Math.max(0, Number(g.scores?.speed||0)),
              accuracy: Math.max(0, Number(g.scores?.accuracy||0))
            }
          }))
        };

        syncInputsFromState();
        renderAll();
        saveState(true);
        toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…");
      }catch(e){
        toast("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù");
      }
    }

    // ========= Export PDF =========
    async function exportPDF(){
      const board = $("#board");
      const { jsPDF } = window.jspdf;

      document.body.classList.add("exporting");
      try{
        await new Promise(r => setTimeout(r, 120));

        const canvas = await html2canvas(board, {
          scale: 2,
          useCORS: true,
          backgroundColor: "#ffffff"
        });

        const imgData = canvas.toDataURL("image/png");
        const pdf = new jsPDF("p", "mm", "a4");
        const pdfW = pdf.internal.pageSize.getWidth();
        const pdfH = pdf.internal.pageSize.getHeight();

        const imgW = pdfW;
        const imgH = (canvas.height * imgW) / canvas.width;

        let heightLeft = imgH;
        let position = 0;

        pdf.addImage(imgData, "PNG", 0, position, imgW, imgH);
        heightLeft -= pdfH;

        while (heightLeft > 0) {
          position = heightLeft - imgH;
          pdf.addPage();
          pdf.addImage(imgData, "PNG", 0, position, imgW, imgH);
          heightLeft -= pdfH;
        }

        const fileName = `Ù„ÙˆØ­Ø©-ØªØ­ÙÙŠØ²-Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª_${new Date().toISOString().slice(0,10)}.pdf`;
        pdf.save(fileName);

        toast("ØªÙ… ØªØµØ¯ÙŠØ± PDF");
      } finally {
        document.body.classList.remove("exporting");
      }
    }

    // ========= Wire =========
    function wire(){
      ["in_grade","in_teacher"].forEach(id => $("#"+id).addEventListener("input", updateHeaderFromInputs));

      $("#btn_add").addEventListener("click", addGroupsFromTextarea);
      $("#btn_clear").addEventListener("click", ()=>{ if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§ØªØŸ")) clearList(); });
      $("#btn_reset_all").addEventListener("click", ()=>{ if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ")) resetAllScores(); });
      $("#btn_sort").addEventListener("click", sortByTotal);

      $("#btn_json").addEventListener("click", exportJSON);
      $("#btn_pdf").addEventListener("click", exportPDF);
      $("#btn_save").addEventListener("click", ()=>{ saveState(true); toast("ØªÙ… Ø§Ù„Ø­ÙØ¸"); });

      $("#file_json").addEventListener("change", (e)=>{
        const f = e.target.files?.[0];
        if(f) importJSON(f);
        e.target.value = "";
      });
    }

    // ========= Init =========
    (function init(){
      // force fixed footer
      state.header.footer = FOOTER_TEXT;
      if(!state.header.date) state.header.date = dateOnly();

      syncInputsFromState();
      setupPalette();
      wire();
      renderAll();
    })();
  </script>
</body>
</html>
